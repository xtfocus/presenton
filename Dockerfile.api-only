FROM python:3.11-slim-bookworm

# Install system dependencies required for FastAPI and document processing
RUN apt-get update && apt-get install -y \
    curl \
    libreoffice \
    fontconfig \
    chromium \
    && rm -rf /var/lib/apt/lists/*

# Create working directory
WORKDIR /app

# Set environment variables
ENV APP_DATA_DIRECTORY=/app_data
ENV TEMP_DIRECTORY=/tmp/presenton
ENV PUPPETEER_EXECUTABLE_PATH=/usr/bin/chromium
ENV PYTHONUNBUFFERED=1

# Install Python dependencies for FastAPI (matching pyproject.toml)
RUN pip install --no-cache-dir \
    aiohttp>=3.12.15 \
    aiomysql>=0.2.0 \
    aiosqlite>=0.21.0 \
    asyncpg>=0.30.0 \
    anthropic>=0.60.0 \
    chromadb>=1.0.15 \
    dirtyjson>=1.0.8 \
    fastapi[standard]>=0.116.1 \
    fastmcp>=2.11.0 \
    google-genai>=1.28.0 \
    nltk>=3.9.1 \
    openai>=1.98.0 \
    pathvalidate>=3.3.1 \
    pdfplumber>=0.11.7 \
    python-pptx>=1.0.2 \
    redis>=6.2.0 \
    sqlmodel>=0.0.24 \
    uvicorn[standard]

# Install docling with PyTorch CPU support
RUN pip install --no-cache-dir docling>=2.43.0 --extra-index-url https://download.pytorch.org/whl/cpu

# Download NLTK data (required for text processing)
RUN python -c "import nltk; nltk.download('punkt', quiet=True); nltk.download('stopwords', quiet=True)"

# Copy only FastAPI server files
COPY servers/fastapi/ ./servers/fastapi/
COPY LICENSE NOTICE ./

# Create app_data directory
RUN mkdir -p /app_data

# Expose FastAPI port
EXPOSE 8000

# Set working directory to FastAPI server
WORKDIR /app/servers/fastapi

# Start FastAPI server directly (no Next.js, no Nginx, no Ollama)
CMD ["python", "server.py", "--port", "8000", "--reload", "false"]

